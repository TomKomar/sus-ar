worker_processes auto;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  tcp_nopush    on;
  tcp_nodelay   on;
  keepalive_timeout 65;

  # Generate ETag for direct files (has no effect on proxied assets, but harmless if enabled)
  etag on;

  # Extra MIME for 3D/webp (kept)
  types {
    model/gltf-binary  glb;
    model/gltf+json    gltf;
    model/vnd.usdz+zip usdz;
    image/webp         webp;
  }

  # IMPORTANT: Docker embedded DNS for dynamic service discovery
  resolver 127.0.0.11 valid=10s ipv6=off;

  # Upstream pool of FastAPI replicas (discovered via DNS)
  upstream app_upstream {
    zone app_upstream 64k;
    least_conn;
    server app:8000 resolve;   # resolves to all "app" tasks created by --scale
    keepalive 64;              # reuse TCP to backends
  }

  # Gzip text assets (kept, with vary/proxied helpers)
  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 5;
  gzip_min_length 1024;
  gzip_types
    text/plain
    text/css
    application/javascript
    application/json
    application/xml
    image/svg+xml;

  # Optional on-disk cache for proxied static assets
  proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=STATIC:10m inactive=10m use_temp_path=off;

  # Common proxy settings
  map $http_upgrade $connection_upgrade { default upgrade; '' close; }

  proxy_connect_timeout   2s;
  proxy_send_timeout     30s;
  proxy_read_timeout     30s;
  send_timeout           30s;

  # Retry another replica on transient errors/timeouts
  proxy_next_upstream error timeout http_502 http_503 http_504;

  server {
    listen 80;
    server_name _;

    # Health for nginx container
    location = /nginx-healthz { return 200; }

    # Security headers (kept)
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header Permissions-Policy "xr-spatial-tracking=(self)" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' https://unpkg.com 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;" always;

    # Allow uploads larger than default if your API needs it
    client_max_body_size 25m;

    # Long cache for big binaries (proxied to app)
    location ~* \.(glb|usdz|webp)$ {
      proxy_pass http://app_upstream;
      proxy_http_version 1.1;

      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # WebSocket/SSE compatibility (harmless if unused)
      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        $connection_upgrade;

      # Optional edge cache for heavy assets
      proxy_cache         STATIC;
      proxy_cache_valid   200 301 302 10m;
      proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;

      # Range support (proxied)
      proxy_set_header Range   $http_range;
      proxy_set_header If-Range $http_if_range;

      # Client caching hints
      expires 1y;
      add_header Cache-Control "public, max-age=31536000, immutable" always;
    }

    # HTML and everything else (no long caching)
    location / {
      proxy_pass http://app_upstream;
      proxy_http_version 1.1;

      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        $connection_upgrade;

      # Keep proxy cache effectively disabled for dynamic pages
      proxy_cache        STATIC;
      proxy_cache_valid  200 302 1s;
      proxy_cache_valid  404      1s;

      add_header Cache-Control "no-cache" always;
    }
  }
}
